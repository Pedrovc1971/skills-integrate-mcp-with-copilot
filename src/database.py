"""\nDatabase module for Mergington High School Activity System\nProvides SQLite persistence for activities and user data\n"""\n\nimport sqlite3\nfrom pathlib import Path\nfrom typing import List, Dict, Optional\n\n# Database file path\nDB_PATH = Path(__file__).parent.parent / "activities.db"\n\n\ndef init_db():\n    """Initialize database with required tables"""\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    # Users table\n    cursor.execute(\"\"\"\n        CREATE TABLE IF NOT EXISTS users (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            email TEXT UNIQUE NOT NULL,\n            password_hash TEXT NOT NULL,\n            full_name TEXT,\n            role TEXT DEFAULT 'student',\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    \"\"\")\n    \n    # Activities table\n    cursor.execute(\"\"\"\n        CREATE TABLE IF NOT EXISTS activities (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            name TEXT UNIQUE NOT NULL,\n            description TEXT,\n            schedule TEXT,\n            max_participants INTEGER,\n            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n        )\n    \"\"\")\n    \n    # Activity participants table\n    cursor.execute(\"\"\"\n        CREATE TABLE IF NOT EXISTS activity_participants (\n            id INTEGER PRIMARY KEY AUTOINCREMENT,\n            activity_id INTEGER NOT NULL,\n            user_email TEXT NOT NULL,\n            signup_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n            FOREIGN KEY (activity_id) REFERENCES activities(id),\n            UNIQUE(activity_id, user_email)\n        )\n    \"\"\")\n    \n    conn.commit()\n    conn.close()\n\n\ndef get_activities() -> List[Dict]:\n    """Retrieve all activities with participant count"""\n    conn = sqlite3.connect(DB_PATH)\n    conn.row_factory = sqlite3.Row\n    cursor = conn.cursor()\n    \n    cursor.execute(\"\"\"\n        SELECT a.id, a.name, a.description, a.schedule, a.max_participants,\n               COUNT(ap.id) as participant_count\n        FROM activities a\n        LEFT JOIN activity_participants ap ON a.id = ap.activity_id\n        GROUP BY a.id\n    \"\"\")\n    \n    activities = [dict(row) for row in cursor.fetchall()]\n    conn.close()\n    return activities\n\n\ndef get_activity_by_name(name: str) -> Optional[Dict]:\n    """Get a single activity by name"""\n    conn = sqlite3.connect(DB_PATH)\n    conn.row_factory = sqlite3.Row\n    cursor = conn.cursor()\n    \n    cursor.execute(\"\"\"\n        SELECT a.id, a.name, a.description, a.schedule, a.max_participants,\n               COUNT(ap.id) as participant_count\n        FROM activities a\n        LEFT JOIN activity_participants ap ON a.id = ap.activity_id\n        WHERE a.name = ?\n        GROUP BY a.id\n    \"\"\", (name,))\n    \n    result = cursor.fetchone()\n    activity = dict(result) if result else None\n    conn.close()\n    return activity\n\n\ndef get_activity_participants(activity_id: int) -> List[str]:\n    """Get list of participant emails for an activity"""\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    cursor.execute(\"\"\"\n        SELECT user_email FROM activity_participants\n        WHERE activity_id = ?\n        ORDER BY signup_date\n    \"\"\", (activity_id,))\n    \n    participants = [row[0] for row in cursor.fetchall()]\n    conn.close()\n    return participants\n\n\ndef signup_for_activity(activity_name: str, email: str) -> bool:\n    """Sign up a user for an activity. Returns True if successful.\"\"\"\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    try:\n        # Get activity id\n        cursor.execute(\"SELECT id FROM activities WHERE name = ?\", (activity_name,))\n        result = cursor.fetchone()\n        \n        if not result:\n            conn.close()\n            return False\n        \n        activity_id = result[0]\n        \n        # Check if already signed up\n        cursor.execute(\n            \"SELECT id FROM activity_participants WHERE activity_id = ? AND user_email = ?\",\n            (activity_id, email)\n        )\n        if cursor.fetchone():\n            conn.close()\n            return False\n        \n        # Add participant\n        cursor.execute(\n            \"INSERT INTO activity_participants (activity_id, user_email) VALUES (?, ?)\",\n            (activity_id, email)\n        )\n        \n        conn.commit()\n        conn.close()\n        return True\n        \n    except sqlite3.IntegrityError:\n        conn.close()\n        return False\n\n\ndef unregister_from_activity(activity_name: str, email: str) -> bool:\n    """Unregister a user from an activity. Returns True if successful.\"\"\"\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    # Get activity id\n    cursor.execute(\"SELECT id FROM activities WHERE name = ?\", (activity_name,))\n    result = cursor.fetchone()\n    \n    if not result:\n        conn.close()\n        return False\n    \n    activity_id = result[0]\n    \n    # Remove participant\n    cursor.execute(\n        \"DELETE FROM activity_participants WHERE activity_id = ? AND user_email = ?\",\n        (activity_id, email)\n    )\n    \n    success = cursor.rowcount > 0\n    conn.commit()\n    conn.close()\n    return success\n\n\ndef create_user(email: str, password_hash: str, full_name: str = \"\", role: str = \"student\") -> bool:\n    """Create a new user. Returns True if successful.\"\"\"\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    try:\n        cursor.execute(\n            \"INSERT INTO users (email, password_hash, full_name, role) VALUES (?, ?, ?, ?)\",\n            (email, password_hash, full_name, role)\n        )\n        conn.commit()\n        conn.close()\n        return True\n    except sqlite3.IntegrityError:\n        conn.close()\n        return False\n\n\ndef get_user(email: str) -> Optional[Dict]:\n    """Get user by email"""\n    conn = sqlite3.connect(DB_PATH)\n    conn.row_factory = sqlite3.Row\n    cursor = conn.cursor()\n    \n    cursor.execute(\"SELECT id, email, password_hash, full_name, role FROM users WHERE email = ?\", (email,))\n    result = cursor.fetchone()\n    user = dict(result) if result else None\n    conn.close()\n    return user\n\n\ndef seed_activities():\n    """Seed database with initial activities"""\n    conn = sqlite3.connect(DB_PATH)\n    cursor = conn.cursor()\n    \n    activities = [\n        (\"Chess Club\", \"Learn strategies and compete in chess tournaments\", \"Fridays, 3:30 PM - 5:00 PM\", 12),\n        (\"Programming Class\", \"Learn programming fundamentals and build software projects\", \"Tuesdays and Thursdays, 3:30 PM - 4:30 PM\", 20),\n        (\"Gym Class\", \"Physical education and sports activities\", \"Mondays, Wednesdays, Fridays, 2:00 PM - 3:00 PM\", 30),\n        (\"Soccer Team\", \"Join the school soccer team and compete in matches\", \"Tuesdays and Thursdays, 4:00 PM - 5:30 PM\", 22),\n        (\"Basketball Team\", \"Practice and play basketball with the school team\", \"Wednesdays and Fridays, 3:30 PM - 5:00 PM\", 15),\n        (\"Art Club\", \"Explore your creativity through painting and drawing\", \"Thursdays, 3:30 PM - 5:00 PM\", 15),\n        (\"Drama Club\", \"Act, direct, and produce plays and performances\", \"Mondays and Wednesdays, 4:00 PM - 5:30 PM\", 20),\n        (\"Math Club\", \"Solve challenging problems and participate in math competitions\", \"Tuesdays, 3:30 PM - 4:30 PM\", 10),\n        (\"Debate Team\", \"Develop public speaking and argumentation skills\", \"Fridays, 4:00 PM - 5:30 PM\", 12),\n    ]\n    \n    for name, desc, schedule, max_part in activities:\n        try:\n            cursor.execute(\n                \"INSERT INTO activities (name, description, schedule, max_participants) VALUES (?, ?, ?, ?)\",\n                (name, desc, schedule, max_part)\n            )\n        except sqlite3.IntegrityError:\n            pass  # Activity already exists\n    \n    conn.commit()\n    conn.close()